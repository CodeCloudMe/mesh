#!/usr/bin/env node
var mesh  = require(".."),
commander = require("commander");

mesh.load(function() {

	var self = this;

	function onLoaded() {
		var commands = self.commands.describe();


		commands.forEach(function(command) {
			if(!command["public"]) return;

			var cmd = commander.command(command.name);
			cmd.description(command.description || "")

			for(var key in command.params) {
				cmd.option("--" + key, command.params[key].description);
			}

			cmd.
			action(function(ops) {
				var context = {};
				for(var key in ops) {
					if(key in command.params) {
						context[key] = ops[key];
					}
				}
				self.run(command.name, context, function(err) {
					if(err) console.error(err);
				});
			});
		});

		commander.parse(process.argv);
	}

	try {
		require(process.cwd() + "/mesh")(self, onLoaded);
	} catch(e) {
		onLoaded();
	}

});